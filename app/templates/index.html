{% extends "base.html" %}

{% block title %}SaltVault - Dashboard{% endblock %}

{% block content %}
    <div class="watermarked">
        <div class="quote-box">
            <p>{{ quote }}</p>
        </div>

        <h2>Password Manager</h2>

        <div class="toolbar mb-3">
            <a href="{{ url_for('main.add_password') }}" class="btn btn-primary me-2">Add Password</a>
            <a href="{{ url_for('main.export_passwords') }}" class="btn btn-secondary me-2">Export</a>
            <a href="{{ url_for('main.import_passwords') }}" class="btn btn-info me-2">Import</a>
        </div>

        <form class="search-form mb-3" method="GET" action="{{ url_for('main.index_route') }}">
            <div class="input-group">
                <input type="text" id="search" name="q" value="{{ q }}" class="form-control" placeholder="Search passwords..." style="color: white;">
                
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#fieldSelector" aria-expanded="false" aria-controls="fieldSelector" style="margin-left: 5px;">
                        Fields
                    </button>
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </div>
            <div id="fieldSelector" class="collapse mt-2">
                <div class="card card-body bg-dark border-secondary">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong class="small" style="color: white;">Filter Fields</strong>
                        <button type="button" class="btn btn-xs btn-link p-0 select-all-fields">Select All</button>
                    </div>
                    {% set active = fields.split(',') if fields else [] %}
                    <div class="row">
                        {% for f in ['title','username','email','notes'] %}
                        <div class="col-6 mb-1">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="{{ f }}" id="field-{{ f }}" {% if f in active %}checked{% endif %}>
                                <label class="form-check-label" for="field-{{ f }}">{{ f.title() }}</label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <input type="hidden" name="fields" id="fields-hidden" value="{{ fields }}">
        </form>

        <form id="bulk-delete-form" method="POST" action="{{ url_for('main.bulk_delete_passwords') }}">
            <div class="table-container mb-2">
                <table class="table table-dark table-striped table-hover">
                    <thead>
                        <tr>
                            <th style="width:42px;" class="select-all-col">
                                <div class="select-all-wrapper" title="Select All">
                                    <input type="checkbox" id="select-all" class="select-all-input">
                                    <label for="select-all" class="select-all-label">All</label>
                                </div>
                            </th>
                            <th>Title</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Password</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for password in passwords %}
                        <tr class="password-row">
                            <td><input type="checkbox" class="row-select" name="selected_ids" value="{{ password.id }}"></td>
                            <td class="truncate" title="{{ password.title }}">{{ password.title }}</td>
                            <td class="truncate" title="{{ password.username }}">{{ password.username }}</td>
                            <td class="truncate" title="{{ password.email }}">{{ password.email }}</td>
                            <td><span id="password-{{ password.id }}" class="decrypted-password">**********</span></td>
                            <td>
                                <button type="button" class="btn btn-sm btn-info toggle-password-visibility" data-id="{{ password.id }}">View</button>
                                <a href="{{ url_for('main.edit_password', password_id=password.id) }}" class="btn btn-sm btn-warning">Edit</a>
                                <form id="delete-form-{{ password.id }}" action="{{ url_for('main.delete_password', password_id=password.id) }}" method="POST" class="d-inline">
                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" data-id="{{ password.id }}">Delete</button>
                                </form>
                            </td>
                        </tr>
                        <tr class="notes-row" id="notes-row-{{ password.id }}" style="display: none;">
                            <td colspan="6">
                                <strong>Notes:</strong>
                                <p id="notes-content-{{ password.id }}"></p>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6">No passwords found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div><small class="text-muted results-text">Showing {{ passwords|length }} result(s)</small></div>
                <button type="button" id="bulk-delete-btn" class="btn btn-danger" disabled data-bs-toggle="modal" data-bs-target="#bulkDeleteModal">Delete Selected</button>
            </div>
        </form>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this password?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bulk Delete Modal -->
    <div class="modal fade modal-dark" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="bulkDeleteModalLabel">Confirm Bulk Deletion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete the selected passwords?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmBulkDeleteBtn">Delete</button>
          </div>
        </div>
      </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Build fields param from checked boxes (updated selector for new UI)
    const fieldChecks = () => Array.from(document.querySelectorAll('#fieldSelector .form-check-input'));
    const hiddenFields = document.getElementById('fields-hidden');
    function syncFieldsHidden(){
        const active = fieldChecks().filter(c => c.checked).map(c => c.value);
        hiddenFields.value = active.join(',');
    }
    fieldChecks().forEach(cb => cb.addEventListener('change', syncFieldsHidden));
    syncFieldsHidden();
    // Select all fields button
    const selectAllBtn = document.querySelector('.select-all-fields');
    if(selectAllBtn){
        selectAllBtn.addEventListener('click', function(e){
            e.preventDefault();
            const all = fieldChecks();
            const allChecked = all.every(c => c.checked);
            all.forEach(c => c.checked = !allChecked);
            syncFieldsHidden();
        });
    }

    // Bulk selection logic
    const selectAll = document.getElementById('select-all');
    const rowSelects = document.querySelectorAll('.row-select');
    const bulkBtn = document.getElementById('bulk-delete-btn');
    function updateBulkState(){
        const anyChecked = Array.from(rowSelects).some(r => r.checked);
        bulkBtn.disabled = !anyChecked;
    }
    selectAll && selectAll.addEventListener('change', () => {
        rowSelects.forEach(r => r.checked = selectAll.checked);
        updateBulkState();
    });
    rowSelects.forEach(r => r.addEventListener('change', updateBulkState));

    const toggleButtons = document.querySelectorAll('.toggle-password-visibility');

    toggleButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault(); // prevent parent form submission
            const passwordId = this.getAttribute('data-id');
            const passwordSpan = document.getElementById(`password-${passwordId}`);
            const notesRow = document.getElementById(`notes-row-${passwordId}`);
            const notesContent = document.getElementById(`notes-content-${passwordId}`);

            if (this.textContent === 'View') {
                passwordSpan.textContent = 'Loading...';
                notesContent.textContent = 'Loading...';

                fetch(`/view-password/${passwordId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.password) {
                            passwordSpan.textContent = data.password;
                            notesContent.textContent = data.notes || 'No notes for this entry.';
                            notesRow.style.display = 'table-row';
                            this.textContent = 'Hide';
                        } else {
                            passwordSpan.textContent = 'Error';
                            notesContent.textContent = 'Error';
                            console.error('Error:', data.error || 'Could not retrieve password.');
                        }
                    })
                    .catch(error => {
                        passwordSpan.textContent = 'Error';
                        notesContent.textContent = 'Error';
                        console.error('There has been a problem with your fetch operation:', error);
                    });
            } else {
                passwordSpan.textContent = '**********';
                notesRow.style.display = 'none';
                this.textContent = 'View';
            }
        });
    });

    // Modal logic
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        let passwordIdToDelete;

        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            passwordIdToDelete = button.getAttribute('data-id');
        });

        confirmDeleteBtn.addEventListener('click', function () {
            const form = document.getElementById(`delete-form-${passwordIdToDelete}`);
            if (form) {
                form.submit();
            }
        });
    }

    const bulkDeleteModal = document.getElementById('bulkDeleteModal');
    if (bulkDeleteModal) {
        const confirmBulkDeleteBtn = document.getElementById('confirmBulkDeleteBtn');
        const bulkDeleteForm = document.getElementById('bulk-delete-form');

        confirmBulkDeleteBtn.addEventListener('click', function () {
            bulkDeleteForm.submit();
        });
    }
});
</script>
{% endblock %}